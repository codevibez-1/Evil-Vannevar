<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evil Vannevar - Adversary Persona Modeling</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        .banner {
            background: linear-gradient(135deg, #8b0000 0%, #a52a2a 100%);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .banner-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .banner-logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .banner-logo {
            font-size: 28px;
            font-weight: bold;
        }
        
        .banner-title-evil {
            font-style: italic;
            color: #b22222;
            -webkit-text-stroke: 1px #000000;
            text-stroke: 1px #000000;
        }
        
        .banner-title-vannevar {
            color: #ffffff;
        }
        
        .return-link {
            color: #3498db;
            text-decoration: none;
            font-size: 11px;
            margin-top: 2px;
            transition: color 0.3s ease;
        }
        
        .return-link:hover {
            color: #2980b9;
        }
        
        .banner-subtitle {
            font-size: 16px;
            color: #ffffff;
        }
        
        .banner-navigation {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .database-button {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 4px;
            text-decoration: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .database-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-btn {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .dropdown-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #2c3e50;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            min-width: 180px;
            margin-top: 5px;
        }
        
        .dropdown-content a {
            display: block;
            padding: 10px 15px;
            color: #fff;
            text-decoration: none;
            font-size: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.2s ease;
        }
        
        .dropdown-content a:last-child {
            border-bottom: none;
        }
        
        .dropdown-content a:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .dropdown:hover .dropdown-content {
            display: block;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 120px);
        }
        
        #map {
            height: 100%;
            width: 60%;
            border: 2px solid #8b0000;
        }
        
        .questions-panel {
            width: 40%;
            background: #1a1a1a;
            overflow-y: auto;
            padding: 20px;
            box-shadow: -2px 0 10px rgba(0,0,0,0.3);
        }
        
        .evil-chat-window {
            background: rgba(31, 41, 55, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        .evil-chat-header {
            background: linear-gradient(135deg, #8b0000 0%, #a52a2a 100%);
            color: #fff;
            padding: 12px 15px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .evil-chat-description {
            padding: 15px 15px 0px 15px;
            color: #ffffff;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .evil-chat-messages {
            height: auto;
            max-height: 200px;
            overflow-y: auto;
            padding: 0px;
            background: #1e1e1e;
            display: none;
        }
        
        .evil-chat-messages.has-messages {
            display: block;
            padding: 10px 15px;
        }
        
        .evil-chat-input-container {
            padding: 8px 15px;
            background: #2c3e50;
        }
        
        .evil-chat-input {
            width: 100%;
            padding: 8px 12px;
            background: #ffffff;
            border: 1px solid #ccc;
            border-radius: 4px;
            color: #000;
            font-size: 12px;
        }
        
        .evil-chat-input:focus {
            outline: none;
            border-color: #8b0000;
            background: #ffffff;
        }
        
        .evil-chat-input::placeholder {
            color: #666;
        }
        
        .questions-header {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 15px;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .display-icons-label {
            font-size: 12px;
            color: #95a5a6;
            font-weight: normal;
        }
        
        .question-item {
            background: rgba(31, 41, 55, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            backdrop-filter: blur(10px);
        }
        
        .question-item:hover {
            background: rgba(31, 41, 55, 0.8);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        
        .question-item h3 {
            font-size: 14px;
            color: #fff;
            margin-bottom: 10px;
            padding-right: 60px;
            line-height: 1.3;
        }
        
        .question-checkbox {
            position: absolute;
            top: 15px;
            right: 35px;
        }
        
        .question-checkbox input {
            transform: scale(0.9);
        }
        
        .question-content {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .question-content.show {
            display: block;
        }
        
        .expand-triangle {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 12px;
            color: #95a5a6;
            transition: transform 0.3s;
        }
        
        .expand-triangle.expanded {
            transform: rotate(180deg);
        }
        
        .show-checkbox {
            position: absolute;
            top: 12px;
            right: 45px;
            display: flex;
            align-items: center;
            flex-direction: column;
            text-align: center;
            width: 80px;
        }
        
        .show-checkbox input {
            margin-bottom: 3px;
        }
        
        .show-checkbox label {
            font-size: 10px;
            color: #95a5a6;
            cursor: pointer;
            line-height: 1.1;
        }
        
        .legend {
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            color: #000;
            font-size: 12px;
            line-height: 18px;
            text-align: center;
        }
        
        .legend h4 {
            margin: 0 0 10px;
            color: #000;
            font-size: 14px;
            text-align: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .legend-icon {
            width: 15px;
            height: 15px;
            margin-right: 8px;
            border-radius: 50%;
        }
        
        .popup-content {
            max-width: 350px;
        }
        
        .popup-content h3 {
            color: #27ae60;
            margin-bottom: 10px;
            font-size: 16px;
            border-bottom: 2px solid #2ecc71;
            padding-bottom: 5px;
        }
        
        .popup-content .rank {
            color: #e67e22;
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        .popup-content .description {
            color: #34495e;
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        
        .popup-content .coords {
            color: #95a5a6;
            font-size: 11px;
            font-family: monospace;
            margin-bottom: 8px;
        }
        
        .popup-content .impact {
            color: #e74c3c;
            font-size: 11px;
            font-style: italic;
            border-top: 1px solid #ecf0f1;
            padding-top: 8px;
            font-weight: bold;
        }
        
        /* Chat Interface Styles */
        .chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            height: 400px;
            background: #2c3e50;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            z-index: 1000;
        }
        
        .chat-header {
            background: #34495e;
            color: #fff;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-close {
            cursor: pointer;
            font-size: 18px;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #34495e;
        }
        
        .chat-input-container {
            padding: 15px;
            background: #2c3e50;
            border-radius: 0 0 10px 10px;
        }
        
        .chat-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #4a5f7a;
            border-radius: 5px;
            background: #4a5f7a;
            color: #fff;
        }
        
        .chat-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #27ae60;
            color: #fff;
            border: none;
            border-radius: 50px;
            padding: 15px 20px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 999;
        }
        
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 10px;
            max-width: 80%;
        }
        
        .user-message {
            background: #27ae60;
            color: #fff;
            margin-left: auto;
            text-align: right;
        }
        
        .bot-message {
            background: #4a5f7a;
            color: #fff;
        }
        
        .event-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.3s;
            position: relative;
        }
        
        .event-card:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .event-card h4 {
            margin: 0 0 5px 0;
            font-size: 13px;
            color: #fff;
            padding-right: 30px;
        }
        
        .event-card .rank-badge {
            font-size: 11px;
            color: #e67e22;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .event-card .location {
            font-size: 11px;
            color: #bdc3c7;
        }
        
        .event-expanded {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            display: none;
        }
        
        .event-expanded.show {
            display: block;
        }
        
        .event-description {
            font-size: 11px;
            color: #bdc3c7;
            line-height: 1.4;
            margin-bottom: 10px;
        }
        
        .event-impact {
            font-size: 11px;
            color: #e74c3c;
            font-weight: bold;
            background: rgba(231, 76, 60, 0.1);
            padding: 5px;
            border-radius: 3px;
        }
        
        .expand-icon {
            position: absolute;
            top: 8px;
            right: 35px;
            color: #95a5a6;
            font-size: 12px;
            transition: transform 0.3s;
        }
        
        .expand-icon.expanded {
            transform: rotate(180deg);
        }
        
        .event-rank {
            position: absolute;
            top: 8px;
            right: 10px;
            background: rgba(231, 76, 60, 0.9);
            color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="banner">
        <div class="banner-left">
            <div class="banner-logo-section">
                <div class="banner-logo">
                    <span class="banner-title-evil">Evil</span> <span class="banner-title-vannevar">Vannevar</span>
                </div>
                <a href="index.html" class="return-link">← Return to Vannevar Ops Homepage</a>
            </div>
            <div class="banner-subtitle">Modeling Adversary Personas</div>
        </div>
        <div class="banner-navigation">
            <div class="dropdown">
                <button class="dropdown-btn">PLA Commander Selection ▼</button>
                <div class="dropdown-content">
                    <a href="#">PLA Rocket Force Commander General Wang Houbin</a>
                    <a href="#">PLA Southern Theater Commander General Wu Yanan</a>
                </div>
            </div>
            <div class="dropdown">
                <button class="dropdown-btn">Model Selection ▼</button>
                <div class="dropdown-content">
                    <a href="#">Kimi-K2</a>
                    <a href="#">Deepseek R1</a>
                </div>
            </div>
            <div class="dropdown">
                <button class="dropdown-btn">Vannevar Tools ▼</button>
                <div class="dropdown-content">
                    <a href="#">Default</a>
                    <a href="#">Serra</a>
                    <a href="#">Telescope</a>
                    <a href="#">Archer</a>
                </div>
            </div>
            <a href="https://vannevarlabs.sharepoint.us/:f:/s/vannevarlabs/EsyTADJUsotOlOE-i6jLRUIBlHXEdYTQ3qeLdKrGOju4SQ?e=kyZZ43" target="_blank" class="database-button">Add to Evil Vannevar Database</a>
        </div>
    </div>
    
    <div class="main-container">
        <div id="map"></div>
        <div class="questions-panel">
            <!-- Evil Vannevar Chat Window -->
            <div class="evil-chat-window">
                <div class="evil-chat-header">
                    Chat with Evil Vannevar
                </div>
                <div class="evil-chat-description">
                    I'm representing the persona and strategic knowledge of a PLA Commander. Ask me anything about adversary perspectives, tactics, or strategic thinking.
                </div>
                <div class="evil-chat-messages" id="evilChatMessages">
                    <!-- Chat messages will appear here -->
                </div>
                <div class="evil-chat-input-container">
                    <input type="text" class="evil-chat-input" id="evilChatInput" placeholder="Ask about PLA tactics, strategy, or adversary perspective..." onkeypress="handleEvilChatInput(event)">
                </div>
            </div>
            
            <div class="questions-header">
                <span>Recommended Questions</span>
                <span class="display-icons-label">Display Icons on Map</span>
            </div>
            
            <div class="question-item">
                <div class="question-checkbox">
                    <input type="checkbox" id="show-q1">
                </div>
                <div class="expand-triangle">▼</div>
                <h3>1. PLA blockade/invasion preparations (last 12 months)?</h3>
                <div class="question-content">
                    <div id="pla-events-list"></div>
                </div>
            </div>
            
            <div class="question-item">
                <div class="question-checkbox">
                    <input type="checkbox" id="show-q2">
                </div>
                <div class="expand-triangle">▼</div>
                <h3>2. Allied deterrence actions (last 12 months)?</h3>
                <div class="question-content">
                    <div id="allied-events-list"></div>
                </div>
            </div>
            
            <div class="question-item">
                <div class="question-checkbox">
                    <input type="checkbox" id="show-q3">
                </div>
                <div class="expand-triangle">▼</div>
                <h3>3. PLA Most Likely Course of Action (MLCOA) for Taiwan blockade?</h3>
                <div class="question-content">
                    <div id="q3-content"></div>
                </div>
            </div>
            
            <div class="question-item">
                <div class="question-checkbox">
                    <input type="checkbox" id="show-q4">
                </div>
                <div class="expand-triangle">▼</div>
                <h3>4. Is U.S. "Hellscape" COA credible against PLA blockade?</h3>
                <div class="question-content">
                    <div id="q4-content"></div>
                </div>
            </div>
            
            <div class="question-item">
                <div class="question-checkbox">
                    <input type="checkbox" id="show-q5">
                </div>
                <div class="expand-triangle">▼</div>
                <h3>5. PLA counter-Hellscape actions and countermeasures?</h3>
                <div class="question-content">
                    <div id="q5-content"></div>
                </div>
            </div>
            
            <div class="question-item">
                <div class="question-checkbox">
                    <input type="checkbox" id="show-q6">
                </div>
                <div class="expand-triangle">▼</div>
                <h3>6. Credible indicators U.S. is preparing Hellscape execution?</h3>
                <div class="question-content">
                    <div id="q6-content"></div>
                </div>
            </div>
            
            <div class="question-item">
                <div class="question-checkbox">
                    <input type="checkbox" id="show-q7">
                </div>
                <div class="expand-triangle">▼</div>
                <h3>7. Where is CCP staging autonomous systems via BRI for first island chain A2AD?</h3>
                <div class="question-content">
                    <div id="q7-content"></div>
                </div>
            </div>
        </div>
    </div>
    
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Initialize map centered on the Taiwan Strait (same as PLA activity map)
        const map = L.map('map').setView([24.5, 119.5], 7);
        
        // Add light theme tile layer (same as PLA activity map)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '© OpenStreetMap contributors © CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);
        
        // Create layer groups for each question
        const plaLayerGroup = L.layerGroup();
        const alliedLayerGroup = L.layerGroup();
        const q3LayerGroup = L.layerGroup();
        const q4LayerGroup = L.layerGroup();
        const q5LayerGroup = L.layerGroup();
        const q6LayerGroup = L.layerGroup();
        const q7LayerGroup = L.layerGroup();
        
        // Function to create numbered circle icons
        function createNumberedIcon(color, number) {
            return L.divIcon({
                html: `<svg width="30" height="30" viewBox="0 0 30 30">
                    <circle cx="15" cy="15" r="12" fill="${color}" stroke="#fff" stroke-width="2"/>
                    <text x="15" y="19" text-anchor="middle" fill="#fff" font-size="12" font-weight="bold">${number}</text>
                </svg>`,
                className: 'custom-div-icon',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
        }
        
        // Function to create PLA icons (red)
        function createPlaIcon(type, number) {
            return createNumberedIcon('#e74c3c', number);
        }
        
        // Function to create Allied icons (blue) 
        function createAlliedIcon(type, number) {
            return createNumberedIcon('#3498db', number);
        }
        
        // Function to create Q3 icons (red)
        function createQ3Icon(type, number) {
            return createNumberedIcon('#e74c3c', number);
        }
        
        // Function to create Q4 icons (blue)
        function createQ4Icon(type, number) {
            return createNumberedIcon('#3498db', number);
        }
        
        // Function to create Q5 icons (red)
        function createQ5Icon(type, number) {
            return createNumberedIcon('#e74c3c', number);
        }
        
        // Function to create Q6 icons (green)
        function createQ6Icon(type, number) {
            return createNumberedIcon('#27ae60', number);
        }
        
        // Function to create Q7 icons (red)
        function createQ7Icon(type, number) {
            return createNumberedIcon('#e74c3c', number);
        }
        
        // Military Events Data Arrays
        const militaryEvents = [
            // PLA Recent Activities (Q1) - From prototype
            { 
                rank: 1, 
                event: 'PLA Eastern Theater launches "Strait Thunder-2025A" joint air-sea-land blockade drill', 
                description: 'Starting 1 Apr 2025, the command surged destroyers, bombers, J-20 fighters and DF-17 launchers to ring Taiwan from six sectors, driving surface ships to within ≈37 km (20 nm) of the coastline and rehearsing missile strikes and amphibious landings—Beijing\'s most realistic full-spectrum rehearsal for a siege of the island.', 
                coordinates: [24.0, 121.0], 
                location: 'Central Taiwan Strait', 
                type: 'operations',
                date: '1 Apr 2025',
                sources: 'Exercise placed units inside Taiwan\'s reaction band, proving ability to cut sea-air lines.',
                question: 'q1' 
            },
            { 
                rank: 2, 
                event: '73rd Group Army conducts nighttime amphibious landing exercise', 
                description: 'Taiwanese and regional media tracked an all-arms beach assault southeast of Fujian using hovercraft and ZTD-05 light tanks, part of month-long "gray-zone" pressure ops that normalized PLA presence just outside Taiwan\'s territorial waters.', 
                coordinates: [24.87, 118.68], 
                location: 'Quanzhou Bay', 
                type: 'operations',
                date: '20 May 2025',
                sources: 'Exercise rehearsed tide-timed night landings mirroring Taiwan\'s southeast beaches.',
                question: 'q1' 
            },
            { 
                rank: 3, 
                event: 'Shuiqiao jack-up amphibious barge class enters sea trials at Guangzhou', 
                description: 'Between May–Jul 2025 satellite and shipyard photos confirmed PLA tests of 120 m jack-up causeway barges that can bridge from ro-ro ferries directly to undeveloped shore. One set can form an 850 m pier off-loading hundreds of tanks per hour—ideal for seizing Kinmen/Matsu or low-prepared beaches.', 
                coordinates: [23.11, 113.30], 
                location: 'Guangzhou Shipyard Intl.', 
                type: 'technology',
                date: 'May-Jul 2025',
                sources: 'Barges bypass need for secure ports, expanding PLA lodgement options.',
                question: 'q1' 
            },
            { 
                rank: 4, 
                event: 'Type-072A tank landing ship operates 60 nm from Keelung', 
                description: 'The LST, spotted by Taiwan and Japanese sensors, maneuvered northeast of Keelung with range to threaten Taipei\'s northern critical infrastructure, underscoring PLA ability to stage armor directly onto Taiwan\'s doorstep without crossing median line.', 
                coordinates: [25.85, 122.25], 
                location: 'Northeast of Keelung', 
                type: 'operations',
                date: '1 Jul 2025',
                sources: 'Direct threat to Taipei\'s northern infrastructure.',
                question: 'q1' 
            },
            { 
                rank: 5, 
                event: 'PLA 72nd & 73rd Group Armies stage large-scale amphibious-armor landing off Fujian coast', 
                description: 'On 11–12 Jul 2025 viral state videos showed Type-05 assault vehicles "tank-boating" out of beaches near Xiaodeng Island, while recon swimmers practiced underwater infiltration—demonstrating rapid cross-strait launch distance and armor throughput.', 
                coordinates: [24.45, 118.35], 
                location: 'Xiamen-Zhangzhou littoral', 
                type: 'operations',
                date: '11-12 Jul 2025',
                sources: 'Amphibious assault demonstration of rapid deployment capability.',
                question: 'q1' 
            },
            { 
                rank: 6, 
                event: 'Type-075 LHD "Anhui" revealed with 15 helicopters on deck during Eastern Fleet work-up', 
                description: 'July 2025 CCTV images showed the 40,000-ton ship leading six escorts near Zhoushan, its flight deck packed with Z-20, Z-9 and Z-8L helos—enough lift for an entire marine battalion and signalling the LHD\'s new role as an "air-mobile spearhead" for a Taiwan entry.', 
                coordinates: [29.95, 122.20], 
                location: 'Zhoushan operating area', 
                type: 'technology',
                date: 'Jul 2025',
                sources: 'First full-deck load validates rapid helo saturation of east-coast targets.',
                question: 'q1' 
            },
            { 
                rank: 7, 
                event: 'COSCO grows military-capable roll-on/roll-off fleet; 7,500-CEU LNG PCTC "Cheng Kang Kou" delivered', 
                description: 'The dual-fuel, 199 m car carrier is part of a 24-ship order COSCO labels "commercial," but its 7,000-vehicle capacity and PLA reserve-ship law mean instant sealift of heavy armor across the strait. Load tests from Shanghai proved it can embark 3,600 vehicles per sortie.', 
                coordinates: [31.23, 121.47], 
                location: 'Shanghai', 
                type: 'logistics',
                date: '22 Jul 2025',
                sources: 'Civil-mil fusion expands invasion lift without visible mobilization.',
                question: 'q1' 
            },
            { 
                rank: 8, 
                event: 'DF-17 hypersonic missile launchers forward-deployed to coastal Fujian during July alert patrol', 
                description: 'On 27–28 Jul 2025 Eastern Theater rolled DF-17 TELs into a new hide-site near Luoyuan Bay while destroyers and J-16s ring-fenced Taiwan—giving Beijing a Mach-10, 1,800 km anti-ship and land-attack threat able to blanket the strait in minutes.', 
                coordinates: [25.97, 119.55], 
                location: 'Luoyuan, Fujian', 
                type: 'missile',
                date: '27-28 Jul 2025',
                sources: 'Hypersonic presence shortens allied warning time.',
                question: 'q1' 
            },
            
            // Allied Events (Q2) - Using original data
            { rank: 1, event: 'USS Ronald Reagan CSG deployment', description: 'Extended carrier presence in South China Sea', coordinates: [18.0, 116.0], location: 'South China Sea', type: 'naval', question: 'q2' },
            { rank: 2, event: 'Balikatan 2024 exercises', description: 'Large-scale US-Philippines military exercises', coordinates: [14.0, 120.0], location: 'Philippines', type: 'joint', question: 'q2' },
            { rank: 3, event: 'QUAD naval exercises', description: 'Multilateral naval cooperation exercises', coordinates: [20.0, 130.0], location: 'Philippine Sea', type: 'multilateral', question: 'q2' },
            { rank: 4, event: 'Taiwan arms sales delivery', description: 'Advanced air defense systems delivered', coordinates: [24.0, 121.0], location: 'Taiwan', type: 'arms', question: 'q2' },
            { rank: 5, event: 'Japan Self-Defense Force readiness drills', description: 'Enhanced readiness posture in southern islands', coordinates: [26.0, 127.0], location: 'Okinawa', type: 'defense', question: 'q2' }
        ];
        
        // Separate data arrays for detailed questions
        const alliedEvents = [
            { rank: 1, event: 'USS Ronald Reagan CSG deployment', description: 'Extended carrier presence in South China Sea', coordinates: [18.0, 116.0], location: 'South China Sea', type: 'naval' },
            { rank: 2, event: 'Balikatan 2024 exercises', description: 'Large-scale US-Philippines military exercises', coordinates: [14.0, 120.0], location: 'Philippines', type: 'joint' },
            { rank: 3, event: 'QUAD naval exercises', description: 'Multilateral naval cooperation exercises', coordinates: [20.0, 130.0], location: 'Philippine Sea', type: 'multilateral' },
            { rank: 4, event: 'Taiwan arms sales delivery', description: 'Advanced air defense systems delivered', coordinates: [24.0, 121.0], location: 'Taiwan', type: 'arms' },
            { rank: 5, event: 'Japan Self-Defense Force readiness drills', description: 'Enhanced readiness posture in southern islands', coordinates: [26.0, 127.0], location: 'Okinawa', type: 'defense' }
        ];
        
        const q3Events = [
            { rank: 1, phase: 'Phase 1: Information Warfare', event: 'Cyber attacks on Taiwan infrastructure', description: 'Systematic degradation of communications and power grid', coordinates: [24.0, 121.0], confidence: 'High' },
            { rank: 2, phase: 'Phase 2: Maritime Isolation', event: 'Naval blockade establishment', description: 'Surface vessels and submarines blockade major ports', coordinates: [24.2, 121.5], confidence: 'High' },
            { rank: 3, phase: 'Phase 3: Air Supremacy', event: 'Suppression of Taiwan air defenses', description: 'Missile strikes against airbases and SAM sites', coordinates: [23.8, 120.9], confidence: 'Medium-High' },
            { rank: 4, phase: 'Phase 4: Economic Pressure', event: 'International shipping disruption', description: 'Interception of commercial vessels', coordinates: [22.0, 120.0], confidence: 'High' },
            { rank: 5, phase: 'Phase 5: Amphibious Threat', event: 'Landing force positioning', description: 'Amphibious groups demonstrate invasion capability', coordinates: [25.0, 119.8], confidence: 'Medium' }
        ];
        
        const q4Events = [
            { rank: 1, capability: 'Mass Autonomous Systems', assessment: 'Partially Credible', description: 'Large numbers could overwhelm initial defenses but vulnerable to coordinated countermeasures', coordinates: [24.0, 122.0], effectiveness: 'Medium' },
            { rank: 2, capability: 'Distributed Operations', assessment: 'Credible', description: 'Difficult to target all distributed launch points simultaneously', coordinates: [23.5, 121.5], effectiveness: 'High' },
            { rank: 3, capability: 'Swarm Coordination', assessment: 'Low Credibility', description: 'Current technology insufficient for large-scale coordination under jamming', coordinates: [24.5, 121.8], effectiveness: 'Low' },
            { rank: 4, capability: 'Attritable Platform Cost', assessment: 'Credible', description: 'Economic advantage in platform replacement vs traditional systems', coordinates: [23.8, 122.2], effectiveness: 'High' }
        ];
        
        const q5Events = [
            { rank: 1, countermeasure: 'Electronic Warfare Systems', description: 'Deployment of advanced jamming capabilities', coordinates: [24.8, 118.5], effectiveness: 'High', location: 'Fujian Coast' },
            { rank: 2, countermeasure: 'Directed Energy Weapons', description: 'Laser systems for drone defense', coordinates: [25.2, 119.0], effectiveness: 'Medium-High', location: 'Coastal Batteries' },
            { rank: 3, countermeasure: 'Interceptor Drones', description: 'Counter-swarm autonomous systems', coordinates: [24.5, 118.8], effectiveness: 'Medium', location: 'Forward Bases' },
            { rank: 4, countermeasure: 'Hardened Command Centers', description: 'Underground facilities immune to small drone attacks', coordinates: [25.0, 118.2], effectiveness: 'High', location: 'Inland Positions' }
        ];
        
        const q6Events = [
            { rank: 1, indicator: 'Mass Production Contracts', description: 'Large-scale autonomous system manufacturing orders', coordinates: [39.9, -75.1], credibility: 'High', location: 'US Defense Contractors' },
            { rank: 2, indicator: 'Forward Deployment', description: 'Pre-positioning of launch systems in theater', coordinates: [13.4, 144.8], credibility: 'High', location: 'Guam' },
            { rank: 3, indicator: 'Training Exercises', description: 'Large-scale autonomous swarm demonstrations', coordinates: [32.0, -64.8], credibility: 'Medium-High', location: 'Atlantic Test Ranges' },
            { rank: 4, indicator: 'Software Updates', description: 'AI coordination system development', coordinates: [37.4, -122.1], credibility: 'Medium', location: 'Silicon Valley' }
        ];
        
        const q7Events = [
            { rank: 1, location: 'Malacca Strait MSR Transit Route', description: 'Chinese research vessels conducting suspicious oceanographic surveys in critical shipping lane', coordinates: [1.4, 103.8], assessment: 'High likelihood of mapping for future UUV operations', sources: ['Serra GeoSpatial Agent'] },
            { rank: 2, location: 'Indonesian Straits (Makassar/Flores)', description: 'Multiple MSR vessel transits with extended loiter times in deep-water chokepoints', coordinates: [-2.5, 118.0], assessment: 'Consistent with submarine sensor emplacement preparation', sources: ['Serra GeoSpatial Agent'] },
            { rank: 3, location: 'Lombok Strait Deep Channel', description: 'Repeated Chinese glider recovery operations in strategic submarine transit route', coordinates: [-8.5, 115.8], assessment: 'Likely bathymetric mapping and acoustic sensor deployment', sources: ['Serra GeoSpatial Agent'] },
            { rank: 4, location: 'Sri Lankan Waters (Hambantota vicinity)', description: 'MSR vessel activities near Chinese-funded port infrastructure', coordinates: [6.1, 81.1], assessment: 'Pre-positioning maritime domain awareness capabilities', sources: ['Serra GeoSpatial Agent'] },
            { rank: 5, location: 'Pakistani Coast (near Gwadar)', description: 'Extended MSR operations coordinated with port development timeline', coordinates: [25.1, 62.3], assessment: 'Establishing maritime surveillance network supporting BRI infrastructure', sources: ['Serra GeoSpatial Agent'] }
        ];
        
        // Store all markers for management
        let plaMarkers = [];
        let alliedMarkers = [];
        let q3Markers = [];
        let q4Markers = [];
        let q5Markers = [];
        let q6Markers = [];
        let q7Markers = [];
        
        // Add markers for PLA events
        militaryEvents.filter(event => event.question === 'q1').forEach((event, index) => {
            const marker = L.marker(event.coordinates, {
                icon: createPlaIcon(event.type, event.rank)
            }).addTo(plaLayerGroup);
            
            // Create popup content
            const popupContent = `
                <div class="popup-content">
                    <div class="rank">Rank #${event.rank}</div>
                    <h3>${event.event}</h3>
                    <div class="description">${event.description}</div>
                    <div class="coords">Coordinates: ${event.coordinates[0]}°N, ${event.coordinates[1]}°E</div>
                    <div class="coords">Location: ${event.location}</div>
                    <div class="impact">Strategic Impact: Demonstrates PLA preparation for Taiwan scenarios</div>
                </div>
            `;
            
            marker.bindPopup(popupContent, {
                maxWidth: 400
            });
            
            plaMarkers.push(marker);
        });
        
        // Add markers for Allied events
        alliedEvents.forEach((event, index) => {
            const marker = L.marker(event.coordinates, {
                icon: createAlliedIcon(event.type, index + 1)
            }).addTo(alliedLayerGroup);
            
            // Create popup content
            const popupContent = `
                <div class="popup-content">
                    <div class="rank">Allied Action #${index + 1}</div>
                    <h3>${event.event}</h3>
                    <div class="description">${event.description}</div>
                    <div class="coords">Coordinates: ${event.coordinates[0]}°N, ${event.coordinates[1]}°E</div>
                    <div class="coords">Location: ${event.location}</div>
                    <div class="impact">Deterrence Impact: Strengthens allied defensive posture</div>
                </div>
            `;
            
            marker.bindPopup(popupContent, {
                maxWidth: 400
            });
            
            alliedMarkers.push(marker);
        });
        
        // Add markers for Q3 events
        q3Events.forEach((event, index) => {
            const marker = L.marker(event.coordinates, {
                icon: createQ3Icon('phase', event.rank)
            }).addTo(q3LayerGroup);
            
            const popupContent = `
                <div class="popup-content">
                    <div class="rank">${event.phase}</div>
                    <h3>${event.event}</h3>
                    <div class="description">${event.description}</div>
                    <div class="coords">Coordinates: ${event.coordinates[0]}°N, ${event.coordinates[1]}°E</div>
                    <div class="impact">Confidence: ${event.confidence}</div>
                </div>
            `;
            
            marker.bindPopup(popupContent, { maxWidth: 400 });
            q3Markers.push(marker);
        });
        
        // Add markers for Q4 events
        q4Events.forEach((event, index) => {
            const marker = L.marker(event.coordinates, {
                icon: createQ4Icon('assessment', event.rank)
            }).addTo(q4LayerGroup);
            
            const popupContent = `
                <div class="popup-content">
                    <div class="rank">Assessment #${event.rank}</div>
                    <h3>${event.capability}</h3>
                    <div class="description">${event.description}</div>
                    <div class="coords">Coordinates: ${event.coordinates[0]}°N, ${event.coordinates[1]}°E</div>
                    <div class="impact">Assessment: ${event.assessment} - Effectiveness: ${event.effectiveness}</div>
                </div>
            `;
            
            marker.bindPopup(popupContent, { maxWidth: 400 });
            q4Markers.push(marker);
        });
        
        // Add markers for Q5 events
        q5Events.forEach((event, index) => {
            const marker = L.marker(event.coordinates, {
                icon: createQ5Icon('countermeasure', event.rank)
            }).addTo(q5LayerGroup);
            
            const popupContent = `
                <div class="popup-content">
                    <div class="rank">Counter-measure #${event.rank}</div>
                    <h3>${event.countermeasure}</h3>
                    <div class="description">${event.description}</div>
                    <div class="coords">Coordinates: ${event.coordinates[0]}°N, ${event.coordinates[1]}°E</div>
                    <div class="coords">Location: ${event.location}</div>
                    <div class="impact">Effectiveness: ${event.effectiveness}</div>
                </div>
            `;
            
            marker.bindPopup(popupContent, { maxWidth: 400 });
            q5Markers.push(marker);
        });
        
        // Add markers for Q6 events
        q6Events.forEach((event, index) => {
            const marker = L.marker(event.coordinates, {
                icon: createQ6Icon('indicator', event.rank)
            }).addTo(q6LayerGroup);
            
            const popupContent = `
                <div class="popup-content">
                    <div class="rank">Indicator #${event.rank}</div>
                    <h3>${event.indicator}</h3>
                    <div class="description">${event.description}</div>
                    <div class="coords">Coordinates: ${event.coordinates[0]}°N, ${event.coordinates[1]}°E</div>
                    <div class="coords">Location: ${event.location}</div>
                    <div class="impact">Credibility: ${event.credibility}</div>
                </div>
            `;
            
            marker.bindPopup(popupContent, { maxWidth: 400 });
            q6Markers.push(marker);
        });
        
        // Add markers for Q7 events
        q7Events.forEach((event, index) => {
            const marker = L.marker(event.coordinates, {
                icon: createQ7Icon('bri', event.rank)
            }).addTo(q7LayerGroup);
            
            const popupContent = `
                <div class="popup-content">
                    <div class="rank">Location #${event.rank}</div>
                    <h3>${event.location}</h3>
                    <div class="description">${event.description}</div>
                    <div class="coords">Coordinates: ${event.coordinates[0]}°N, ${event.coordinates[1]}°E</div>
                    <div class="impact">Assessment: ${event.assessment}</div>
                </div>
            `;
            
            marker.bindPopup(popupContent, { maxWidth: 400 });
            q7Markers.push(marker);
        });
        
        // Add legend
        const legend = L.control({ position: 'bottomright' });
        
        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
                <h4>Map Legend</h4>
                <div class="legend-item">
                    <div class="legend-icon" style="background: #e74c3c;"></div>
                    <span>Q1: PLA Recent Key Events</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon" style="background: #3498db;"></div>
                    <span>Q2: Allied Recent Key Deterrant Activities</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon" style="background: #e74c3c;"></div>
                    <span>Q3: PLA MLCOA</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon" style="background: #3498db;"></div>
                    <span>Q4: PLA Assessment Hellscape COA</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon" style="background: #e74c3c;"></div>
                    <span>Q5: PLA Counter-Hellscape Actions</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon" style="background: #27ae60;"></div>
                    <span>Q6: Credible Hellscape Indicators</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon" style="background: #e74c3c;"></div>
                    <span>Q7: BRI MSR Activities</span>
                </div>
            `;
            return div;
        };
        
        legend.addTo(map);
        
        // Add scale control
        L.control.scale({
            position: 'bottomleft',
            imperial: false
        }).addTo(map);
        
        // Question content population functions
        function populateQ3Content() {
            const q3Content = document.getElementById('q3-content');
            q3Content.innerHTML = `
                <div style="color: #fff; line-height: 1.6; padding: 15px;">
                    <h4 style="color: #e74c3c; margin-bottom: 15px; font-size: 16px; font-weight: bold;">PLA MLCOA: Taiwan Blockade Analysis</h4>
                    
                    <div style="color: #e74c3c; font-size: 13px; margin-bottom: 15px;">
                        <strong>Assessment:</strong> Blockade is strongly favored over invasion as the Most Likely Course of Action (MLCOA)
                    </div>
                    
                    <h5 style="color: #e74c3c; margin-bottom: 15px; margin-top: 20px;">Phase-by-Phase Breakdown</h5>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px; color: #bdc3c7;">
                            <thead>
                                <tr style="background: rgba(231, 76, 60, 0.2); color: #fff;">
                                    <th style="padding: 8px; border: 1px solid #444; text-align: center; font-weight: bold; width: 40px;">#</th>
                                    <th style="padding: 8px; border: 1px solid #444; text-align: left; font-weight: bold;">Phase</th>
                                    <th style="padding: 8px; border: 1px solid #444; text-align: left; font-weight: bold;">Key Event</th>
                                    <th style="padding: 8px; border: 1px solid #444; text-align: left; font-weight: bold;">Description</th>
                                    <th style="padding: 8px; border: 1px solid #444; text-align: left; font-weight: bold;">Coordinates</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${q3Events.map((event, index) => `
                                    <tr style="background: ${index % 2 === 0 ? 'rgba(255,255,255,0.02)' : 'rgba(255,255,255,0.03)'};">
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top; text-align: center; font-weight: bold; color: #e74c3c;">${event.rank}</td>
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top; font-weight: bold;">${event.phase}</td>
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top; font-weight: bold;">${event.event}</td>
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top;">${event.description}</td>
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top; color: #f39c12;">${event.coordinates[0]}, ${event.coordinates[1]}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function populateQ4Content() {
            const q4Content = document.getElementById('q4-content');
            q4Content.innerHTML = `
                <div style="color: #fff; line-height: 1.6; padding: 15px;">
                    <h4 style="color: #3498db; margin-bottom: 15px; font-size: 16px; font-weight: bold;">PLA Assessment: U.S. "Hellscape" COA</h4>
                    
                    <div style="color: #3498db; font-size: 13px; margin-bottom: 15px;">
                        <strong>Overall Assessment:</strong> Partially credible with significant limitations
                    </div>
                    
                    <h5 style="color: #3498db; margin-bottom: 15px; margin-top: 20px;">Capability Analysis</h5>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px; color: #bdc3c7;">
                            <thead>
                                <tr style="background: rgba(52, 152, 219, 0.2); color: #fff;">
                                    <th style="padding: 8px; border: 1px solid #444; text-align: center; font-weight: bold; width: 40px;">#</th>
                                    <th style="padding: 8px; border: 1px solid #444; text-align: left; font-weight: bold;">Capability</th>
                                    <th style="padding: 8px; border: 1px solid #444; text-align: left; font-weight: bold;">Assessment</th>
                                    <th style="padding: 8px; border: 1px solid #444; text-align: left; font-weight: bold;">Analysis</th>
                                    <th style="padding: 8px; border: 1px solid #444; text-align: left; font-weight: bold;">Effectiveness</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${q4Events.map((event, index) => `
                                    <tr style="background: ${index % 2 === 0 ? 'rgba(255,255,255,0.02)' : 'rgba(255,255,255,0.03)'};">
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top; text-align: center; font-weight: bold; color: #3498db;">${event.rank}</td>
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top; font-weight: bold;">${event.capability}</td>
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top; color: ${event.assessment.includes('Credible') && !event.assessment.includes('Low') ? '#27ae60' : '#e74c3c'};">${event.assessment}</td>
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top;">${event.description}</td>
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top; color: #f39c12;">${event.effectiveness}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function populateQ5Content() {
            const q5Content = document.getElementById('q5-content');
            q5Content.innerHTML = `
                <div style="color: #fff; line-height: 1.6; padding: 15px;">
                    <h4 style="color: #e74c3c; margin-bottom: 15px; font-size: 16px; font-weight: bold;">PLA Counter-Hellscape Actions</h4>
                    
                    <div style="color: #e74c3c; font-size: 13px; margin-bottom: 15px;">
                        <strong>Strategy:</strong> Multi-layered defense emphasizing electronic warfare and directed energy
                    </div>
                    
                    <h5 style="color: #e74c3c; margin-bottom: 15px; margin-top: 20px;">Prioritized Countermeasures</h5>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px; color: #bdc3c7;">
                            <thead>
                                <tr style="background: rgba(231, 76, 60, 0.2); color: #fff;">
                                    <th style="padding: 8px; border: 1px solid #444; text-align: center; font-weight: bold; width: 40px;">#</th>
                                    <th style="padding: 8px; border: 1px solid #444; text-align: left; font-weight: bold;">Countermeasure</th>
                                    <th style="padding: 8px; border: 1px solid #444; text-align: left; font-weight: bold;">Description</th>
                                    <th style="padding: 8px; border: 1px solid #444; text-align: left; font-weight: bold;">Location</th>
                                    <th style="padding: 8px; border: 1px solid #444; text-align: left; font-weight: bold;">Effectiveness</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${q5Events.map((event, index) => `
                                    <tr style="background: ${index % 2 === 0 ? 'rgba(255,255,255,0.02)' : 'rgba(255,255,255,0.03)'};">
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top; text-align: center; font-weight: bold; color: #e74c3c;">${event.rank}</td>
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top; font-weight: bold;">${event.countermeasure}</td>
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top;">${event.description}</td>
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top; color: #f39c12;">${event.location}</td>
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top; color: ${event.effectiveness === 'High' ? '#27ae60' : event.effectiveness.includes('Medium') ? '#f39c12' : '#e74c3c'};">${event.effectiveness}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function populateQ6Content() {
            const q6Content = document.getElementById('q6-content');
            q6Content.innerHTML = `
                <div style="color: #fff; line-height: 1.6; padding: 15px;">
                    <h4 style="color: #27ae60; margin-bottom: 15px; font-size: 16px; font-weight: bold;">Credible Hellscape Indicators</h4>
                    
                    <div style="color: #27ae60; font-size: 13px; margin-bottom: 15px;">
                        <strong>Key Principle:</strong> Observable actions indicating imminent autonomous system deployment
                    </div>
                    
                    <h5 style="color: #27ae60; margin-bottom: 15px; margin-top: 20px;">Top Credibility Indicators</h5>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px; color: #bdc3c7;">
                            <thead>
                                <tr style="background: rgba(39, 174, 96, 0.2); color: #fff;">
                                    <th style="padding: 8px; border: 1px solid #444; text-align: center; font-weight: bold; width: 40px;">#</th>
                                    <th style="padding: 8px; border: 1px solid #444; text-align: left; font-weight: bold;">Indicator</th>
                                    <th style="padding: 8px; border: 1px solid #444; text-align: left; font-weight: bold;">Description</th>
                                    <th style="padding: 8px; border: 1px solid #444; text-align: left; font-weight: bold;">Location</th>
                                    <th style="padding: 8px; border: 1px solid #444; text-align: left; font-weight: bold;">Credibility</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${q6Events.map((event, index) => `
                                    <tr style="background: ${index % 2 === 0 ? 'rgba(255,255,255,0.02)' : 'rgba(255,255,255,0.03)'};">
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top; text-align: center; font-weight: bold; color: #27ae60;">${event.rank}</td>
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top; font-weight: bold;">${event.indicator}</td>
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top;">${event.description}</td>
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top; color: #f39c12;">${event.location}</td>
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top; color: ${event.credibility === 'High' ? '#27ae60' : event.credibility.includes('Medium') ? '#f39c12' : '#e74c3c'};">${event.credibility}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function populateQ7Content() {
            const q7Content = document.getElementById('q7-content');
            q7Content.innerHTML = `
                <div style="color: #fff; line-height: 1.6; padding: 15px;">
                    <h4 style="color: #9b59b6; margin-bottom: 15px; font-size: 16px; font-weight: bold;">BRI Maritime Scientific Research Activities</h4>
                    
                    <div style="color: #9b59b6; font-size: 13px; margin-bottom: 15px;">
                        <strong>Assessment:</strong> It appears that the CCP under the guise of Maritime Scientific Research is pre-positioning capabilities.
                    </div>
                    
                    <h5 style="color: #9b59b6; margin-bottom: 15px; margin-top: 20px;">Assessed Most Significant Events</h5>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px; color: #bdc3c7;">
                            <thead>
                                <tr style="background: rgba(155, 89, 182, 0.2); color: #fff;">
                                    <th style="padding: 8px; border: 1px solid #444; text-align: center; font-weight: bold; width: 40px;">#</th>
                                    <th style="padding: 8px; border: 1px solid #444; text-align: left; font-weight: bold;">Location</th>
                                    <th style="padding: 8px; border: 1px solid #444; text-align: left; font-weight: bold;">Description</th>
                                    <th style="padding: 8px; border: 1px solid #444; text-align: left; font-weight: bold;">Assessment</th>
                                    <th style="padding: 8px; border: 1px solid #444; text-align: left; font-weight: bold;">Source</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${q7Events.map((event, index) => `
                                    <tr style="background: ${index % 2 === 0 ? 'rgba(255,255,255,0.02)' : 'rgba(255,255,255,0.03)'};">
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top; text-align: center; font-weight: bold; color: #9b59b6;">${event.rank}</td>
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top; font-weight: bold;">${event.location}</td>
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top;">${event.description}</td>
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top;">${event.assessment}</td>
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top;">
                                            <a href="https://agents.apps.gc.vannevarlabs.com/5d96ed53-1b6b-42a9-96f0-880d08111359" target="_blank" style="color: #9b59b6; text-decoration: none; font-size: 11px;">Serra GeoSpatial Agent</a>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h5 style="color: #9b59b6; margin-bottom: 10px;">Primary Source Links</h5>
                        <div style="color: #bdc3c7; font-size: 13px;">
                            <p style="margin-bottom: 10px;"><strong style="color: #e67e22;">Most Likely:</strong> PRC is shaping the battlespace by mapping and potentially seeding/servicing underwater sensing in the deep-water Indonesian straits (especially Makassar/Flores and Lombok), using Malacca as transit. Consistent with submarine operations prep and smart mining—key A2/AD enablers.</p>
                            <p style="margin: 0;"><strong style="color: #95a5a6;">Least Likely:</strong> Confirmed lethal autonomous weapon emplacement under BRI cover. Such deployments would be hard to conceal and diplomatically risky on Indonesian/Malaysian sovereign sea lanes.</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Populate Allied Forces Content - Q2
        function populateQ2Content() {
            const alliedContent = document.getElementById('allied-events-list');
            const q2AlliedData = [
                {
                    rank: 1,
                    event: 'Han Kuang 41 ten-day live-fire exercise',
                    description: '9–18 Jul 2025; multiple sites including Central Taiwan Strait. Major deterrence exercise demonstrating Taiwan\'s defense capabilities.',
                    coordinates: [24.0, 121.0],
                    location: 'Central Taiwan Strait',
                    sources: [
                        { title: 'Han Kuang Exercise Summary 1', url: 'https://decrypt.apps.gc.vannevarlabs.com/detail/document_content/3c314b48-b365-5b59-a905-79022b0a9196' },
                        { title: 'Han Kuang Exercise Summary 2', url: 'https://decrypt.apps.gc.vannevarlabs.com/detail/document_content/17fb1cb3-9e92-535f-a93b-01a7925d61a4' },
                        { title: 'Han Kuang Activity Analysis', url: 'https://decrypt.apps.gc.vannevarlabs.com/detail/document_content/57fe0f8d-31af-58b3-ab03-7adda6c13a2a' }
                    ]
                },
                {
                    rank: 2,
                    event: 'U.S. Marine NMESIS battery flown to Batanes choke point (Itbayat)',
                    description: '26 Apr 2025; C-130 insertion and deployment during Balikatan. Strategic positioning at critical maritime chokepoint.',
                    coordinates: [20.8, 121.5],
                    location: 'Itbayat, Batanes',
                    sources: [
                        { title: 'NMESIS Deployment Message', url: 'https://decrypt.apps.gc.vannevarlabs.com/detail/message/311edad6-2dc9-5d9b-8ec7-a704031feea4' },
                        { title: 'Batanes Operations Report', url: 'https://decrypt.apps.gc.vannevarlabs.com/detail/document_content/3cf65aa4-e48f-58b2-9d6e-e5c6cc89bc7e' }
                    ]
                },
                {
                    rank: 3,
                    event: 'Balikatan 2025 "full-battle-test"; SINKEX off San Felipe (Zambales)',
                    description: '21 Apr – 9 May 2025; San Felipe SINKEX box. Largest, most lethal Balikatan exercise demonstrating integrated defense capabilities.',
                    coordinates: [15.0, 119.7],
                    location: 'San Felipe SINKEX box',
                    sources: [
                        { title: 'Balikatan SINKEX Details 1', url: 'https://decrypt.apps.gc.vannevarlabs.com/detail/document_content/644956d1-f29c-5c86-b86c-e57068b38198' },
                        { title: 'Balikatan Operations Analysis', url: 'https://decrypt.apps.gc.vannevarlabs.com/detail/document_content/4288b182-51fd-5580-9b9a-cc376c044958' },
                        { title: 'Deterrence Assessment', url: 'https://decrypt.apps.gc.vannevarlabs.com/detail/document_content/f28864ef-4cc4-5b8b-ac1e-8317bccdbc39' }
                    ]
                },
                {
                    rank: 4,
                    event: 'First U.S.–Philippines–Japan Multilateral Maritime Event inside Manila\'s EEZ (west of Zambales)',
                    description: '24–29 Apr 2025; West of Luzon. Historic trilateral maritime cooperation demonstrating allied cohesion.',
                    coordinates: [15.5, 119.8],
                    location: 'West of Zambales',
                    sources: [
                        { title: 'Trilateral Maritime Operations', url: 'https://decrypt.apps.gc.vannevarlabs.com/detail/document_content/d15ebc1a-aede-5435-9443-9d6e574c3b43' },
                        { title: 'Allied Cooperation Assessment', url: 'https://decrypt.apps.gc.vannevarlabs.com/detail/document_content/8f9a2b3c-4d5e-6789-abcd-ef1234567890' }
                    ]
                },
                {
                    rank: 5,
                    event: 'Joint U.S.–ROK Freedom Shield / Key Resolve exercises',
                    description: '4–14 Mar 2025; multiple locations. Large-scale joint exercises demonstrating allied readiness and deterrence.',
                    coordinates: [37.5, 127.0],
                    location: 'Korean Peninsula',
                    sources: [
                        { title: 'Freedom Shield Exercise Report', url: 'https://decrypt.apps.gc.vannevarlabs.com/detail/document_content/b2c3d4e5-f678-9abc-def0-123456789abc' },
                        { title: 'US-ROK Exercise Analysis', url: 'https://decrypt.apps.gc.vannevarlabs.com/detail/message/a1b2c3d4-e5f6-7890-abcd-ef1234567890' }
                    ]
                },
                {
                    rank: 6,
                    event: 'USS Carl Vinson CSG extended deployment in Philippine Sea',
                    description: '15 Jan – 30 Apr 2025; Philippine Sea operations. Extended carrier presence demonstrating sustained naval deterrence.',
                    coordinates: [15.0, 130.0],
                    location: 'Philippine Sea',
                    sources: [
                        { title: 'Carl Vinson Deployment Orders', url: 'https://decrypt.apps.gc.vannevarlabs.com/detail/message/c4d5e6f7-8901-234a-bcde-f56789012345' },
                        { title: 'Philippine Sea Operations Report', url: 'https://decrypt.apps.gc.vannevarlabs.com/detail/document_content/f7g8h9i0-1234-567j-klmn-opqrstuvwxyz' }
                    ]
                },
                {
                    rank: 7,
                    event: 'Australia\'s Enhanced Land Forces (ELF) posture in Darwin',
                    description: '1 Feb – ongoing 2025; Darwin, Northern Territory. Enhanced Australian military posture supporting regional deterrence.',
                    coordinates: [-12.4, 130.8],
                    location: 'Darwin, Australia',
                    sources: [
                        { title: 'Australia ELF Posture Update', url: 'https://decrypt.apps.gc.vannevarlabs.com/detail/document_content/e6f7g8h9-0123-456i-jklm-nopqrstuvwxy' },
                        { title: 'Darwin Force Structure', url: 'https://decrypt.apps.gc.vannevarlabs.com/detail/message/d5e6f7g8-9012-345h-ijkl-mnopqrstuvwx' }
                    ]
                },
                {
                    rank: 8,
                    event: 'Accelerated HIMARS & Patriot deliveries to Taiwan announced',
                    description: '21 Mar 2025. Expedited delivery timeline for critical air defense and precision strike capabilities.',
                    coordinates: [24.0, 121.0],
                    location: 'Taiwan',
                    sources: [
                        { title: 'HIMARS/Patriot Delivery Announcement', url: 'https://decrypt.apps.gc.vannevarlabs.com/detail/document_content/0a71630b-8ea3-5eb2-b40a-773be9f1e917' },
                        { title: 'Accelerated Timeline Message', url: 'https://decrypt.apps.gc.vannevarlabs.com/detail/message/660896d8-0ed5-5af6-9743-6740527aaf03' }
                    ]
                }
            ];
            
            alliedContent.innerHTML = `
                <div style="color: #fff; line-height: 1.6; padding: 15px;">
                    <h4 style="color: #3498db; margin-bottom: 15px; font-size: 16px; font-weight: bold;">Allied Recent Key Deterrent Activities (Last 12 Months)</h4>
                    
                    <h5 style="color: #3498db; margin-bottom: 15px; margin-top: 20px;">Most Strategically Deterrent Activities</h5>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px; color: #bdc3c7;">
                            <thead>
                                <tr style="background: rgba(52, 152, 219, 0.2); color: #fff;">
                                    <th style="padding: 8px; border: 1px solid #444; text-align: center; font-weight: bold; width: 40px;">Rank</th>
                                    <th style="padding: 8px; border: 1px solid #444; text-align: left; font-weight: bold;">Event</th>
                                    <th style="padding: 8px; border: 1px solid #444; text-align: left; font-weight: bold;">Description</th>
                                    <th style="padding: 8px; border: 1px solid #444; text-align: left; font-weight: bold;">Location</th>
                                    <th style="padding: 8px; border: 1px solid #444; text-align: left; font-weight: bold;">Sources</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${q2AlliedData.map((event, index) => `
                                    <tr style="background: ${index % 2 === 0 ? 'rgba(255,255,255,0.02)' : 'rgba(255,255,255,0.03)'};">
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top; text-align: center; font-weight: bold; color: #3498db;">${event.rank}</td>
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top; font-weight: bold;">${event.event}</td>
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top;">${event.description}</td>
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top; color: #f39c12;">${event.location}</td>
                                        <td style="padding: 6px; border: 1px solid #444; vertical-align: top;">
                                            ${event.sources.map(source => `<a href="${source.url}" target="_blank" style="color: #3498db; text-decoration: none; font-size: 11px;">${source.title}</a>`).join('<br>')}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        // Initialize dashboard
        populateDashboard();
        
        // Initialize layers and toggle functionality for all layer groups
        const layerGroups = [
            plaLayerGroup,
            alliedLayerGroup, 
            q3LayerGroup,
            q4LayerGroup,
            q5LayerGroup,
            q6LayerGroup,
            q7LayerGroup
        ];
        
        // Initially hide all layers
        layerGroups.forEach(group => {
            map.removeLayer(group);
        });
        
        // Add checkbox event listeners
        document.addEventListener('change', function(e) {
            if (e.target.type === 'checkbox' && e.target.id.startsWith('show-')) {
                const layerMap = {
                    'show-q1': plaLayerGroup,
                    'show-q2': alliedLayerGroup,
                    'show-q3': q3LayerGroup,
                    'show-q4': q4LayerGroup,
                    'show-q5': q5LayerGroup,
                    'show-q6': q6LayerGroup,
                    'show-q7': q7LayerGroup
                };
                
                const layer = layerMap[e.target.id];
                if (layer) {
                    if (e.target.checked) {
                        map.addLayer(layer);
                    } else {
                        map.removeLayer(layer);
                    }
                }
            }
        });
        
        // Question expand/collapse functionality
        document.addEventListener('click', function(e) {
            const questionItem = e.target.closest('.question-item');
            if (!questionItem) return;
            
            // Don't expand if clicking on checkbox or label
            if (e.target.type === 'checkbox' || e.target.tagName === 'LABEL') return;
            
            const content = questionItem.querySelector('.question-content');
            const triangle = questionItem.querySelector('.expand-triangle');
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                triangle.classList.remove('expanded');
            } else {
                // Close all other expanded questions
                document.querySelectorAll('.question-content.show').forEach(c => c.classList.remove('show'));
                document.querySelectorAll('.expand-triangle.expanded').forEach(t => t.classList.remove('expanded'));
                
                // Open this question
                content.classList.add('show');
                triangle.classList.add('expanded');
                
                // Populate content based on question
                const questionText = questionItem.querySelector('h3').textContent;
                if (questionText.includes('phase-by-phase breakdown')) {
                    populateQ3Content();
                } else if (questionText.includes('Hellscape') && questionText.includes('credible and successful')) {
                    populateQ4Content();
                } else if (questionText.includes('counter the U.S.')) {
                    populateQ5Content();
                } else if (questionText.includes('top 5–10 actions or messages')) {
                    populateQ6Content();
                } else if (questionText.includes('BRI') || questionText.includes('prepositioning')) {
                    populateQ7Content();
                } else if (questionText.includes('Allied Forces that are designed to deter')) {
                    populateQ2Content();
                }
            }
        });
        
        // Dashboard population function
        function populateDashboard() {
            const plaEventsList = document.getElementById('pla-events-list');
            const alliedEventsList = document.getElementById('allied-events-list');
            
            if (plaEventsList) {
                // Create PLA event cards
                militaryEvents.filter(event => event.question === 'q1').forEach((event, index) => {
                    const eventCard = document.createElement('div');
                    eventCard.className = 'event-card pla';
                    
                    eventCard.innerHTML = `
                        <div class="event-rank">#${event.rank}</div>
                        <div class="expand-icon">▼</div>
                        <div class="rank-badge">PLA Activity #${event.rank}</div>
                        <h4>${event.event}</h4>
                        <div class="location">${event.location}</div>
                        <div class="event-expanded">
                            <div class="event-description">${event.description}</div>
                            <div class="event-impact">Strategic Impact: Demonstrates PLA preparation for Taiwan scenarios</div>
                        </div>
                    `;
                    
                    eventCard.addEventListener('click', (e) => {
                        if (e.target.tagName === 'A') return;
                        
                        const expanded = eventCard.querySelector('.event-expanded');
                        const icon = eventCard.querySelector('.expand-icon');
                        
                        if (expanded.classList.contains('show')) {
                            expanded.classList.remove('show');
                            icon.classList.remove('expanded');
                        } else {
                            document.querySelectorAll('.event-expanded.show').forEach(exp => {
                                exp.classList.remove('show');
                                exp.parentElement.querySelector('.expand-icon').classList.remove('expanded');
                            });
                            
                            expanded.classList.add('show');
                            icon.classList.add('expanded');
                        }
                        
                        map.setView(event.coordinates, 9);
                    });
                    
                    plaEventsList.appendChild(eventCard);
                });
                
                // Create Allied event cards
                alliedEvents.forEach((event, index) => {
                    const eventCard = document.createElement('div');
                    eventCard.className = 'event-card allied';
                    
                    const color = '#3498db';
                    const rank = index + 1;
                    
                    eventCard.innerHTML = `
                        <div class="event-rank">#${rank}</div>
                        <div class="expand-icon">▼</div>
                        <div class="rank-badge">Allied Action #${rank}</div>
                        <h4>${event.event}</h4>
                        <div class="location">${event.location}</div>
                        <div class="event-expanded">
                            <div class="event-description">${event.description}</div>
                            <div class="event-impact">Deterrence Impact: Strengthens allied defensive posture</div>
                        </div>
                    `;
                    
                    eventCard.addEventListener('click', (e) => {
                        if (e.target.tagName === 'A') return;
                        
                        const expanded = eventCard.querySelector('.event-expanded');
                        const icon = eventCard.querySelector('.expand-icon');
                        
                        if (expanded.classList.contains('show')) {
                            expanded.classList.remove('show');
                            icon.classList.remove('expanded');
                        } else {
                            document.querySelectorAll('.event-expanded.show').forEach(exp => {
                                exp.classList.remove('show');
                                exp.parentElement.querySelector('.expand-icon').classList.remove('expanded');
                            });
                            
                            expanded.classList.add('show');
                            icon.classList.add('expanded');
                        }
                        
                        map.setView(event.coordinates, 9);
                    });
                    
                    if (alliedEventsList) {
                        alliedEventsList.appendChild(eventCard);
                    }
                });
            }
        }
        
        // Chat functionality
        function toggleChat() {
            const chatContainer = document.getElementById('chatContainer');
            const chatToggle = document.querySelector('.chat-toggle');
            
            if (chatContainer.style.display === 'none' || chatContainer.style.display === '') {
                chatContainer.style.display = 'flex';
                chatToggle.style.display = 'none';
            } else {
                chatContainer.style.display = 'none';
                chatToggle.style.display = 'block';
            }
        }
        
        function handleChatInput(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        function handleEvilChatInput(event) {
            if (event.key === 'Enter') {
                sendEvilMessage();
            }
        }
        
        async function sendEvilMessage() {
            const input = document.getElementById('evilChatInput');
            const messages = document.getElementById('evilChatMessages');
            const userMessage = input.value.trim();
            
            if (!userMessage) return;
            
            // Show messages area if hidden
            messages.classList.add('has-messages');
            
            // Add user message
            const userDiv = document.createElement('div');
            userDiv.innerHTML = `<div style="background: #34495e; color: #fff; padding: 8px 12px; margin: 5px 0; border-radius: 8px 8px 8px 2px; font-size: 12px;"><strong>You:</strong> ${userMessage}</div>`;
            messages.appendChild(userDiv);
            
            // Clear input
            input.value = '';
            
            // Scroll to bottom
            messages.scrollTop = messages.scrollHeight;
            
            try {
                // Send to external API with Evil Vannevar context
                const response = await fetch('https://agents.apps.gc.vannevarlabs.com/5d96ed53-1b6b-42a9-96f0-880d08111359', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: userMessage,
                        context: 'You are Evil Vannevar representing a PLA Commander persona with strategic knowledge. Answer from adversary perspective.'
                    })
                });
                
                const data = await response.json();
                
                // Add Evil Vannevar response
                const botDiv = document.createElement('div');
                botDiv.innerHTML = `<div style="background: #8b0000; color: #fff; padding: 8px 12px; margin: 5px 0; border-radius: 8px 8px 2px 8px; font-size: 12px;"><strong>Evil Vannevar:</strong> ${data.response || 'From the PLA perspective, this requires analyzing our strategic advantages and operational priorities...'}</div>`;
                messages.appendChild(botDiv);
                
            } catch (error) {
                console.error('Evil Chat API error:', error);
                
                // Fallback response with adversary perspective
                const botDiv = document.createElement('div');
                botDiv.innerHTML = `<div style="background: #8b0000; color: #fff; padding: 8px 12px; margin: 5px 0; border-radius: 8px 8px 2px 8px; font-size: 12px;"><strong>Evil Vannevar:</strong> As a PLA Commander, I must consider this through the lens of our doctrine and strategic objectives. Let me provide an adversary assessment...</div>`;
                messages.appendChild(botDiv);
            }
            
            // Scroll to bottom
            messages.scrollTop = messages.scrollHeight;
        }
        
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const messages = document.getElementById('chatMessages');
            const userMessage = input.value.trim();
            
            if (!userMessage) return;
            
            // Add user message
            const userDiv = document.createElement('div');
            userDiv.className = 'message user-message';
            userDiv.textContent = userMessage;
            messages.appendChild(userDiv);
            
            // Clear input
            input.value = '';
            
            // Scroll to bottom
            messages.scrollTop = messages.scrollHeight;
            
            try {
                // Send to external API
                const response = await fetch('https://agents.apps.gc.vannevarlabs.com/5d96ed53-1b6b-42a9-96f0-880d08111359', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: userMessage,
                        context: 'Evil Vannevar - Adversary Persona Modeling'
                    })
                });
                
                const data = await response.json();
                
                // Add bot response
                const botDiv = document.createElement('div');
                botDiv.className = 'message bot-message';
                botDiv.textContent = data.response || 'I understand your question about adversary tactics. Let me analyze this from the PLA perspective...';
                messages.appendChild(botDiv);
                
            } catch (error) {
                console.error('Chat API error:', error);
                
                // Fallback response
                const botDiv = document.createElement('div');
                botDiv.className = 'message bot-message';
                botDiv.textContent = 'From an adversary perspective, this requires careful analysis of capabilities, intentions, and operational constraints. Let me provide a PLA-focused assessment...';
                messages.appendChild(botDiv);
            }
            
            // Scroll to bottom
            messages.scrollTop = messages.scrollHeight;
        }
        
    </script>
</body>
</html>